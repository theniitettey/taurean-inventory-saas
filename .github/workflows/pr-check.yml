name: Pull Request Check

on:
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  # Quick Build Check
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Backend Build Check
      - name: Backend Build Check
        run: |
          echo "ğŸ”§ Checking Backend Build..."
          cd backend
          npm ci
          npm run build
          echo "âœ… Backend build successful!"

      # Frontend Build Check
      - name: Frontend Build Check
        run: |
          echo "ğŸ”§ Checking Frontend Build..."
          cd frontend
          npm ci
          npm run build
          echo "âœ… Frontend build successful!"

      # Type Check
      - name: Type Check
        run: |
          echo "ğŸ” Running Type Checks..."
          cd backend && npm run lint
          cd ../frontend && npm run lint
          echo "âœ… Type checks passed!"

  # Security Check
  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Security Audit
        run: |
          echo "ğŸ”’ Running Security Audit..."
          cd backend && npm audit --audit-level=moderate || true
          cd ../frontend && npm audit --audit-level=moderate || true
          echo "âœ… Security check completed!"

  # Code Quality
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check Code Formatting
        run: |
          echo "ğŸ¨ Checking Code Formatting..."
          cd backend && npm run lint || true
          cd ../frontend && npm run lint || true
          echo "âœ… Code quality check completed!"

  # Summary
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-check, security-check, code-quality]
    if: always()

    steps:
      - name: Build Status Summary
        run: |
          echo "ğŸ“Š Build Summary for PR #${{ github.event.number }}"
          echo "================================================"
          echo "Backend Build: ${{ needs.build-check.result }}"
          echo "Frontend Build: ${{ needs.build-check.result }}"
          echo "Security Check: ${{ needs.security-check.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          
          if [[ "${{ needs.build-check.result }}" == "success" ]]; then
            echo "ğŸ‰ All builds successful! Ready for review."
          else
            echo "âŒ Build failed. Please check the logs above."
            exit 1
          fi